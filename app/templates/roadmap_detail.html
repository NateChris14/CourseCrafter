{% extends "base.html" %}
{% block content %}
<h1>{{ roadmap.title }}</h1>
<p><b>Field:</b> {{ roadmap.field }} | <b>Level:</b> {{ roadmap.level }} | <b>Weeks:</b> {{ roadmap.duration_weeks }}</p>

<form method="post" action="/roadmaps/{{ roadmap.id }}/generate">
  <button type="submit">Generate outline</button>
</form>

<div id="runBox" style="margin-top:16px; display:none;">
  <p><b>Status:</b> <span id="status"></span></p>
  <p><b>Progress:</b> <span id="progress"></span>%</p>
  <p id="message"></p>

  <p id="actions" style="margin: 10px 0;"></p>

  <div id="outline"></div>

  <details style="margin-top: 12px;">
    <summary>Show raw JSON</summary>
    <pre id="result" style="white-space:pre-wrap;"></pre>
  </details>
</div>

<script>
  const params = new URLSearchParams(window.location.search);
  const runId = params.get("run");
  const box = document.getElementById("runBox");
  const actions = document.getElementById("actions");
  const outlineDiv = document.getElementById("outline");

  function renderOutline(outline) {
    outlineDiv.innerHTML = "";
    const weeks = outline?.weeks || [];
    if (!weeks.length) {
      outlineDiv.innerHTML = "<p><i>No outline weeks found.</i></p>";
      return;
    }

    weeks.sort((a, b) => (a.week ?? 0) - (b.week ?? 0));

    for (const w of weeks) {
      const section = document.createElement("section");
      section.style.margin = "16px 0";
      section.style.padding = "12px";
      section.style.border = "1px solid #333";
      section.style.borderRadius = "8px";

      const h2 = document.createElement("h2");
      h2.textContent = `Week ${w.week} â€” ${w.title}`;
      section.appendChild(h2);

      const ul = document.createElement("ul");
      for (const o of (w.outcomes || [])) {
        const li = document.createElement("li");
        li.textContent = o;
        ul.appendChild(li);
      }
      section.appendChild(ul);

      outlineDiv.appendChild(section);
    }
  }

  if (runId) {
    box.style.display = "block";

    async function poll() {
      const res = await fetch(`/runs/${runId}`);
      const data = await res.json();

      document.getElementById("status").textContent = data.status;
      document.getElementById("progress").textContent = data.progress ?? 0;
      document.getElementById("message").textContent = data.message ?? "";

      if (data.status === "succeeded") {
        actions.innerHTML = "";

        if (data.course_id) {
          const link = document.createElement("a");
          link.href = `/courses/${data.course_id}`;
          link.textContent = "View course";
          actions.appendChild(link);
        }

        document.getElementById("result").textContent = data.result_json || "";

        try {
          const outline = JSON.parse(data.result_json);
          renderOutline(outline);
        } catch (e) {
          outlineDiv.innerHTML = "<p class='error'><i>Could not parse outline JSON.</i></p>";
        }
        return;
      }

      if (data.status === "failed") {
        outlineDiv.innerHTML = "";
        document.getElementById("result").textContent = data.error || "Failed";
        actions.innerHTML = "";
        return;
      }

      setTimeout(poll, 1500);
    }

    poll();
  }
</script>
{% endblock %}
