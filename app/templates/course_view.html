{% extends "base.html" %}
{% block content %}

<h1>{{ course.title }}</h1>
{% if course.description %}<p>{{ course.description }}</p>{% endif %}

<form method="post" action="/courses/{{ course.id }}/generate" style="margin: 12px 0;">
  <button type="submit">Generate full course (Markdown)</button>
</form>

{% if run_id %}
  <section id="runBox" style="margin: 12px 0; padding: 12px; border: 1px solid #444; border-radius: 8px;">
    <h3 style="margin: 0 0 8px 0;">Generation status</h3>
    <div>Status: <b id="runStatus">Loading…</b></div>
    <div>Progress: <span id="runProgress">0</span>%</div>
    <div id="runMessage" style="margin-top: 6px; color: #bbb;"></div>
    <div id="runError" style="margin-top: 6px; color: #ff6b6b;"></div>
  </section>

  <script>
    (function () {
      const runId = "{{ run_id }}";
      const statusEl = document.getElementById("runStatus");
      const progressEl = document.getElementById("runProgress");
      const messageEl = document.getElementById("runMessage");
      const errorEl = document.getElementById("runError");

      async function poll() {
        try {
          const res = await fetch(`/runs/${runId}`, { cache: "no-store" });
          if (!res.ok) throw new Error(`HTTP ${res.status}`);
          const data = await res.json();

          statusEl.textContent = data.status || "";
          progressEl.textContent = (data.progress ?? 0);
          messageEl.textContent = data.message || "";
          errorEl.textContent = data.error || "";

          if (data.status === "succeeded" || data.status === "failed") {
            window.location.href = `/courses/{{ course.id }}`;
            return;
          }
        } catch (e) {
          messageEl.textContent = "Polling error. Retrying…";
        }

        setTimeout(poll, 1200);
      }

      poll();
    })();
  </script>
{% endif %}

{% for m in modules %}
  <section style="margin: 16px 0; padding: 12px; border: 1px solid #333; border-radius: 8px;">
    <h2>Week {{ m.week }} — {{ m.title }}</h2>

    {% if m.outcomes and m.outcomes|length > 0 %}
      <h3>Outcomes</h3>
      <ul>
        {% for o in m.outcomes %}
          <li>{{ o }}</li>
        {% endfor %}
      </ul>
    {% endif %}

    {% if m.content_html %}
      <h3>Lesson</h3>
      <div class="lesson">
        {{ m.content_html }}
      </div>
    {% else %}
      <p><i>Lesson content not generated yet.</i></p>
    {% endif %}
  </section>
{% endfor %}

{% endblock %}
